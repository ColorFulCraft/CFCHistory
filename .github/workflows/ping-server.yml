name: Daily MC Server Ping

on:
  schedule:
    # 每天UTC时间0点运行（北京时间8点）
    - cron: '0 0 * * *'
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]

jobs:
  ping-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        
    - name: 设置Java环境
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
        
    - name: 创建目录结构
      run: |
        mkdir -p src stats
        ls -la
        
    - name: 创建Java源码文件
      run: |
        # 从仓库读取或创建Java文件
        if [ -f "src/MCPing.java" ]; then
          echo "使用现有的MCPing.java"
        else
          echo "创建MCPing.java..."
          echo "请确保src/MCPing.java已存在"
        fi
        
    - name: 创建编译运行脚本
      run: |
        cat > compile-run.sh << 'EOF'
        #!/bin/bash
        
        echo "开始编译 MCPing.java..."
        
        # 编译Java文件
        javac -d bin src/MCPing.java
        
        if [ $? -ne 0 ]; then
          echo "编译失败！"
          exit 1
        fi
        
        echo "编译成功！"
        echo "正在ping服务器 mc.cfcmc.cc:25565..."
        
        # 运行程序
        java -cp bin MCPing stats/server.json
        
        if [ $? -ne 0 ]; then
          echo "运行失败！"
          exit 1
        fi
        
        echo "数据已保存到 stats/server.json"
        
        # 显示结果
        echo -e "\n服务器状态："
        if command -v jq &> /dev/null; then
          cat stats/server.json | jq .
        else
          cat stats/server.json
        fi
        EOF
        
        chmod +x compile-run.sh
        
    - name: 编译和运行
      run: |
        ./compile-run.sh
        
    - name: 验证JSON文件
      run: |
        if [ -f "stats/server.json" ]; then
          echo "JSON文件已生成"
          echo "文件内容："
          cat stats/server.json
        else
          echo "JSON文件未生成"
          exit 1
        fi
        
    - name: 提交更新
      run: |
        # 配置Git
        git config --local user.email "leng@ipacel.cc"
        git config --local user.name "CFCAT"
        
        # 检查是否有更改
        if git diff --quiet stats/server.json; then
          echo "无变化"
        else
          echo "提交数据更新"
          git add stats/server.json
          git commit -m "CFCAT 更新服务器状态数据 $(date '+%Y-%m-%d %H:%M:%S')"
          
          # 推送到仓库
          git push origin HEAD:main
        fi
        
    - name: 上传JSON文件作为产物
      uses: actions/upload-artifact@v3
      with:
        name: server-status
        path: stats/server.json
