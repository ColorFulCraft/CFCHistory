name: Auto Build Docs

on:
  push:
    paths:
      - 'docs/**'
      - '.github/workflows/docs-auto.yml'
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Generate Sidebar
      run: |
        # åˆ›å»ºè‡ªåŠ¨ç”Ÿæˆè„šæœ¬
        cat > gen-sidebar.py << 'EOF'
        import os
        import json
        from datetime import datetime
        
        docs_dir = 'docs'
        sidebar_file = os.path.join(docs_dir, '_sidebar.md')
        
        # è·å–æ‰€æœ‰.mdæ–‡ä»¶
        md_files = []
        for file in os.listdir(docs_dir):
            if file.endswith('.md') and not file.startswith('_'):
                md_files.append(file)
        
        # åˆ†ç±»æ–‡ä»¶
        categories = {
            'é¦–é¡µ': [],
            'ç›®å½•': [],
            'å›¢é˜Ÿ': [],
            'å†å²': [],
            'å…¶ä»–': []
        }
        
        for file in sorted(md_files):
            if file == 'README.md':
                categories['é¦–é¡µ'].append({'name': 'ğŸ  æ–‡æ¡£é¦–é¡µ', 'file': file})
            elif file == 'Directory.md':
                categories['ç›®å½•'].append({'name': 'ğŸ“– ç›®å½•æ€»è§ˆ', 'file': file})
            elif file == 'about.md':
                categories['å›¢é˜Ÿ'].append({'name': 'ğŸ¨ ç®¡ç†å›¢é˜Ÿä»‹ç»', 'file': file})
            elif file.startswith('history'):
                # æå–é¡µç 
                if file == 'history.md':
                    page_num = 1
                    name = 'å†å²è®°è½½ ç¬¬1é¡µ'
                else:
                    # æå– history_2.md ä¸­çš„æ•°å­—
                    try:
                        page_num = int(file.replace('history_', '').replace('.md', ''))
                        name = f'å†å²è®°è½½ ç¬¬{page_num}é¡µ'
                    except:
                        page_num = 999
                        name = file.replace('.md', '')
                
                categories['å†å²'].append({
                    'name': name,
                    'file': file,
                    'page_num': page_num
                })
            else:
                categories['å…¶ä»–'].append({'name': f'ğŸ“„ {file.replace(".md", "")}', 'file': file})
        
        # å¯¹å†å²æ–‡æ¡£æŒ‰é¡µç æ’åº
        categories['å†å²'].sort(key=lambda x: x['page_num'])
        
        # ç”Ÿæˆä¾§è¾¹æ å†…å®¹
        content = f"""<!-- 
  è‡ªåŠ¨ç”Ÿæˆçš„ä¾§è¾¹æ 
  ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
  ä¸è¦æ‰‹åŠ¨ä¿®æ”¹æ­¤æ–‡ä»¶ï¼Œä¿®æ”¹ä¼šè¢«è¦†ç›–
-->

"""
        
        # é¦–é¡µ
        for item in categories['é¦–é¡µ']:
            content += f"- [{item['name']}]({item['file']})\n\n"
        
        # ç›®å½•
        if categories['ç›®å½•']:
            content += "## ğŸ“– ç›®å½•\n"
            for item in categories['ç›®å½•']:
                content += f"- [{item['name']}]({item['file']})\n"
            content += "\n"
        
        # å›¢é˜Ÿ
        if categories['å›¢é˜Ÿ']:
            content += "## ğŸ¨ ç®¡ç†å›¢é˜Ÿ\n"
            for item in categories['å›¢é˜Ÿ']:
                content += f"- [{item['name']}]({item['file']})\n"
            content += "\n"
        
        # å†å²
        if categories['å†å²']:
            content += "## ğŸ“œ å†å²è®°è½½\n\n"
            for item in categories['å†å²']:
                content += f"- [{item['name']}]({item['file']})\n"
            content += "\n"
        
        # å…¶ä»–
        if categories['å…¶ä»–']:
            content += "## ğŸ“„ å…¶ä»–æ–‡æ¡£\n"
            for item in categories['å…¶ä»–']:
                content += f"- [{item['name']}]({item['file']})\n"
            content += "\n"
        
        # å¤–éƒ¨é“¾æ¥
        content += """## ğŸ”— å¿«é€Ÿé“¾æ¥
- [è¿”å›ä¸»é¡µ](../index.html)
- [GitHubä»“åº“](https://github.com/ColorFulCraft/CFCHistory)
- [åŠ å…¥QQç¾¤](https://qm.qq.com/q/L8kNa8IJqu)
"""
        
        # å†™å…¥æ–‡ä»¶
        with open(sidebar_file, 'w', encoding='utf-8') as f:
            f.write(content)
        
        print(f"âœ… ç”Ÿæˆä¾§è¾¹æ å®Œæˆï¼Œå…± {len(md_files)} ä¸ªæ–‡æ¡£")
        print(f"ğŸ“ å†å²æ–‡æ¡£: {len(categories['å†å²'])} é¡µ")
        
        # ç”Ÿæˆç»Ÿè®¡æ•°æ®
        stats = {
            'generated_at': datetime.now().isoformat(),
            'total_files': len(md_files),
            'history_pages': len(categories['å†å²']),
            'categories': {k: len(v) for k, v in categories.items()}
        }
        
        with open(os.path.join(docs_dir, '_stats.json'), 'w', encoding='utf-8') as f:
            json.dump(stats, f, ensure_ascii=False, indent=2)
        
        EOF
        
        python gen-sidebar.py
        
    - name: Create .nojekyll
      run: touch .nojekyll
      
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/_sidebar.md docs/_stats.json .nojekyll
        git diff --cached --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ä¾§è¾¹æ  [skip ci]"
        git push
