// æ”¾ç½®åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼šgenerate-docs.js
const fs = require('fs');
const path = require('path');
const https = require('https');

class DocsGenerator {
  constructor() {
    this.docsDir = path.join(__dirname, 'docs');
    this.sidebarPath = path.join(this.docsDir, '_sidebar.md');
    this.configPath = path.join(this.docsDir, '_config.json');
  }

  // ä»GitHub APIè·å–æ–‡ä»¶åˆ—è¡¨
  async fetchDocsFromGitHub() {
    return new Promise((resolve, reject) => {
      const options = {
        hostname: 'api.github.com',
        path: '/repos/ColorFulCraft/CFCHistory/contents/docs',
        headers: {
          'User-Agent': 'Docs-Generator',
          'Accept': 'application/vnd.github.v3+json'
        }
      };

      https.get(options, (res) => {
        let data = '';
        res.on('data', chunk => data += chunk);
        res.on('end', () => {
          try {
            const files = JSON.parse(data);
            resolve(files);
          } catch (e) {
            reject(e);
          }
        });
      }).on('error', reject);
    });
  }

  // åˆ†ç±»æ–‡æ¡£æ–‡ä»¶
  categorizeFiles(files) {
    const categories = {
      'é¦–é¡µ': [],
      'ç›®å½•': [],
      'å›¢é˜Ÿ': [],
      'å†å²': [],
      'å…¶ä»–': []
    };

    files.forEach(file => {
      if (file.type === 'file' && file.name.endsWith('.md')) {
        const fileName = file.name;
        
        if (fileName === 'README.md') {
          categories['é¦–é¡µ'].push({
            name: 'ğŸ  æ–‡æ¡£é¦–é¡µ',
            file: fileName,
            size: file.size
          });
        } else if (fileName === 'Directory.md') {
          categories['ç›®å½•'].push({
            name: 'ğŸ“– ç›®å½•æ€»è§ˆ',
            file: fileName,
            size: file.size
          });
        } else if (fileName === 'about.md') {
          categories['å›¢é˜Ÿ'].push({
            name: 'ğŸ¨ ç®¡ç†å›¢é˜Ÿä»‹ç»',
            file: fileName,
            size: file.size
          });
        } else if (fileName.startsWith('history')) {
          const pageNum = this.extractPageNumber(fileName);
          let displayName = 'ğŸ“œ å†å²è®°è½½';
          
          if (fileName === 'history.md') {
            displayName = 'ğŸ“œ å†å²è®°è½½ï¼ˆç¬¬ä¸€é¡µï¼‰';
          } else if (pageNum) {
            displayName = `ğŸ“œ å†å²è®°è½½ï¼ˆç¬¬${pageNum}é¡µï¼‰`;
          }
          
          categories['å†å²'].push({
            name: displayName,
            file: fileName,
            pageNum: pageNum,
            size: file.size
          });
        } else {
          // å…¶ä»–æ–‡æ¡£
          const displayName = this.formatDisplayName(fileName);
          categories['å…¶ä»–'].push({
            name: `ğŸ“„ ${displayName}`,
            file: fileName,
            size: file.size
          });
        }
      }
    });

    // å¯¹å†å²æ–‡æ¡£æŒ‰é¡µç æ’åº
    categories['å†å²'].sort((a, b) => {
      if (a.pageNum === undefined) return -1;
      if (b.pageNum === undefined) return 1;
      return a.pageNum - b.pageNum;
    });

    return categories;
  }

  // æå–é¡µç 
  extractPageNumber(fileName) {
    const match = fileName.match(/history[_-]?(\d+)\.md$/i);
    return match ? parseInt(match[1]) : null;
  }

  // æ ¼å¼åŒ–æ˜¾ç¤ºåç§°
  formatDisplayName(fileName) {
    return fileName
      .replace('.md', '')
      .replace(/[_-]/g, ' ')
      .replace(/^\w/, c => c.toUpperCase())
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  // ç”Ÿæˆä¾§è¾¹æ Markdown
  generateSidebar(categories) {
    let content = `<!-- 
  è‡ªåŠ¨ç”Ÿæˆçš„ä¾§è¾¹æ 
  ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
  ä¸è¦æ‰‹åŠ¨ä¿®æ”¹æ­¤æ–‡ä»¶ï¼Œä¿®æ”¹ä¼šè¢«è¦†ç›–
-->\n\n`;

    // é¦–é¡µ
    if (categories['é¦–é¡µ'].length > 0) {
      const home = categories['é¦–é¡µ'][0];
      content += `- [${home.name}](${home.file})\n\n`;
    }

    // å…¶ä»–åˆ†ç±»
    const categoryOrder = ['ç›®å½•', 'å›¢é˜Ÿ', 'å†å²', 'å…¶ä»–'];
    
    categoryOrder.forEach(category => {
      const items = categories[category];
      if (items.length > 0) {
        const icon = this.getCategoryIcon(category);
        content += `## ${icon} ${category}\n\n`;
        
        items.forEach(item => {
          const sizeInfo = item.size > 1024 ? ` (${Math.round(item.size/1024)}KB)` : '';
          content += `- [${item.name}](${item.file})${sizeInfo}\n`;
        });
        
        content += '\n';
      }
    });

    // å¤–éƒ¨é“¾æ¥
    content += `## ğŸ”— å¿«é€Ÿé“¾æ¥\n\n`;
    content += `- [è¿”å›ç‚«é…·é¦–é¡µ](../index.html)\n`;
    content += `- [GitHubä»“åº“](https://github.com/ColorFulCraft/CFCHistory)\n`;
    content += `- [åŠ å…¥QQç¾¤](https://qm.qq.com/q/L8kNa8IJqu)\n`;
    content += `- [æŸ¥çœ‹å·¥ä½œæµ](../.github/workflows/docs-build.yml)\n`;

    return content;
  }

  getCategoryIcon(category) {
    const icons = {
      'é¦–é¡µ': 'ğŸ ',
      'ç›®å½•': 'ğŸ“–',
      'å›¢é˜Ÿ': 'ğŸ¨',
      'å†å²': 'ğŸ“œ',
      'å…¶ä»–': 'ğŸ“„'
    };
    return icons[category] || 'ğŸ“„';
  }

  // ç”Ÿæˆé…ç½®æ–‡ä»¶
  generateConfig(categories) {
    const config = {
      generated_at: new Date().toISOString(),
      total_docs: Object.values(categories).reduce((sum, items) => sum + items.length, 0),
      categories: {},
      stats: {
        last_updated: new Date().toISOString(),
        version: '1.0.0'
      }
    };

    Object.keys(categories).forEach(category => {
      config.categories[category] = categories[category].map(item => ({
        file: item.file,
        display_name: item.name,
        page_num: item.pageNum,
        size: item.size
      }));
    });

    return JSON.stringify(config, null, 2);
  }

  // ç”Ÿæˆæ–‡æ¡£ç´¢å¼•
  generateIndex(categories) {
    const totalDocs = Object.values(categories).reduce((sum, items) => sum + items.length, 0);
    
    let index = `# ğŸ“š æ–‡æ¡£ç´¢å¼•\n\n`;
    index += `> æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')} | å…± ${totalDocs} ç¯‡æ–‡æ¡£\n\n`;
    
    Object.entries(categories).forEach(([category, items]) => {
      if (items.length > 0) {
        const icon = this.getCategoryIcon(category);
        index += `## ${icon} ${category} (${items.length}ç¯‡)\n\n`;
        
        items.forEach(item => {
          const size = item.size > 1024 ? `${Math.round(item.size/1024)}KB` : `${item.size}B`;
          index += `- [${item.name.replace(/^[^\s]+\s/, '')}](${item.file}) - ${size}\n`;
        });
        
        index += '\n';
      }
    });

    return index;
  }

  // ä¸»ç”Ÿæˆå‡½æ•°
  async generate() {
    try {
      console.log('ğŸš€ å¼€å§‹ç”Ÿæˆæ–‡æ¡£ç³»ç»Ÿ...');
      
      // ä»GitHubè·å–æ–‡ä»¶ï¼ˆæˆ–æœ¬åœ°æ‰«æï¼‰
      let files;
      try {
        files = await this.fetchDocsFromGitHub();
        console.log('âœ… ä»GitHub APIè·å–æ–‡ä»¶æˆåŠŸ');
      } catch (error) {
        console.log('âš ï¸  GitHub APIè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ–‡ä»¶');
        files = this.scanLocalFiles();
      }
      
      // åˆ†ç±»æ–‡ä»¶
      const categories = this.categorizeFiles(files);
      
      // ç”Ÿæˆä¾§è¾¹æ 
      const sidebarContent = this.generateSidebar(categories);
      fs.writeFileSync(this.sidebarPath, sidebarContent);
      console.log('âœ… ä¾§è¾¹æ ç”Ÿæˆå®Œæˆ');
      
      // ç”Ÿæˆé…ç½®æ–‡ä»¶
      const configContent = this.generateConfig(categories);
      fs.writeFileSync(this.configPath, configContent);
      console.log('âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ');
      
      // ç”Ÿæˆç´¢å¼•é¡µé¢
      const indexPath = path.join(this.docsDir, 'INDEX.md');
      const indexContent = this.generateIndex(categories);
      fs.writeFileSync(indexPath, indexContent);
      console.log('âœ… ç´¢å¼•é¡µé¢ç”Ÿæˆå®Œæˆ');
      
      // è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
      this.printStats(categories);
      
      console.log('ğŸ‰ æ–‡æ¡£ç³»ç»Ÿç”Ÿæˆå®Œæˆï¼');
      
    } catch (error) {
      console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
      process.exit(1);
    }
  }

  // æœ¬åœ°æ–‡ä»¶æ‰«æï¼ˆå¤‡ç”¨ï¼‰
  scanLocalFiles() {
    const files = [];
    
    if (fs.existsSync(this.docsDir)) {
      const items = fs.readdirSync(this.docsDir);
      
      items.forEach(item => {
        const itemPath = path.join(this.docsDir, item);
        const stats = fs.statSync(itemPath);
        
        files.push({
          name: item,
          type: stats.isDirectory() ? 'dir' : 'file',
          size: stats.size,
          path: itemPath
        });
      });
    }
    
    return files;
  }

  // æ‰“å°ç»Ÿè®¡ä¿¡æ¯
  printStats(categories) {
    console.log('\nğŸ“Š æ–‡æ¡£ç»Ÿè®¡ä¿¡æ¯:');
    console.log('â•'.repeat(50));
    
    const total = Object.values(categories).reduce((sum, items) => sum + items.length, 0);
    console.log(`ğŸ“š æ€»æ–‡æ¡£æ•°: ${total}`);
    
    Object.entries(categories).forEach(([category, items]) => {
      if (items.length > 0) {
        const icon = this.getCategoryIcon(category);
        console.log(`${icon} ${category}: ${items.length}ç¯‡`);
      }
    });
    
    console.log('â•'.repeat(50));
    console.log(`ğŸ•’ ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}`);
    console.log(`ğŸ“ ä¾§è¾¹æ æ–‡ä»¶: ${this.sidebarPath}`);
  }
}

// è¿è¡Œç”Ÿæˆå™¨
const generator = new DocsGenerator();
generator.generate().catch(console.error);
