name: PR Handler

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [closed]

jobs:
  handle-new-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Greet PR Contributor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          AUTHOR="${{ github.event.pull_request.user.login }}"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¯„è®º
          COMMENTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments")
          
          # å¦‚æœæ²¡æœ‰è¯„è®ºï¼Œåˆ™æ·»åŠ æ¬¢è¿è¯„è®º
          if echo "$COMMENTS" | grep -q "body"; then
            echo "å·²æœ‰è¯„è®ºï¼Œè·³è¿‡..."
          else
            MESSAGE="ä½ å¥½ @$AUTHORï¼Œæ„Ÿè°¢æäº¤PRï¼\næˆ‘ä»¬ä¼šå°½æ—©å®¡æ ¸å›åº”ğŸ˜Š\n\nHi @$AUTHOR, thanks for opening the Pull Request!\nWe will respond to it as soon as possibleğŸ˜Š"
            
            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -X POST \
              -d "{\"body\":\"$MESSAGE\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"
            echo "å·²æ·»åŠ æ¬¢è¿è¯„è®º"
          fi

  handle-closed-pr:
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Check if PR was merged
        id: check-merged
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}")
          
          MERGED=$(echo "$PR_DATA" | jq -r '.merged')
          echo "merged=$MERGED" >> $GITHUB_OUTPUT

      - name: Thank Contributor (on merge)
        if: steps.check-merged.outputs.merged == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          AUTHOR="${{ github.event.pull_request.user.login }}"
          MESSAGE="æ„Ÿè°¢ @$AUTHOR çš„è´¡çŒ®ï¼æ‚¨çš„PRå·²è¢«åˆå¹¶ï¼Œæ„Ÿè°¢æ‚¨ä¸ºé¡¹ç›®åšå‡ºçš„åŠªåŠ›ï¼ğŸ‰\nThank you @$AUTHOR for your contribution! Your PR has been merged. We appreciate your effort! ğŸ‰"
          
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -X POST \
               -d "{\"body\":\"$MESSAGE\"}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"

      - name: Acknowledge Closed PR
        if: steps.check-merged.outputs.merged == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          AUTHOR="${{ github.event.pull_request.user.login }}"
          MESSAGE="@$AUTHOR è¾›è‹¦äº†ï¼è™½ç„¶è¿™æ¬¡PRæ²¡æœ‰åˆå¹¶ï¼Œä½†è¿˜æ˜¯æ„Ÿè°¢æ‚¨çš„ä»˜å‡ºï¼ŒæœŸå¾…ä¸‹æ¬¡åˆä½œï¼ğŸ™\n@$AUTHOR, thank you for your effort! Although this PR wasn't merged, we appreciate your contribution and look forward to collaborating again! ğŸ™"
          
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -X POST \
               -d "{\"body\":\"$MESSAGE\"}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"
