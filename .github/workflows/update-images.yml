name: Update Images Timestamp

on:
  schedule:
    - cron: "0 */2 * * *"  # æ¯2å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆåœ¨0åˆ†é’Ÿï¼‰
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update-images:
    runs-on: ubuntu-slim 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check last commit time (skip if within 30 minutes)
        id: check-time
        run: |
          # è·å–ä¸Šä¸€æ¬¡commitçš„æ—¶é—´
          LAST_COMMIT_TIME=$(git log -1 --format=%ct 2>/dev/null || echo "0")
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_COMMIT_TIME))
          
          # å¦‚æœ30åˆ†é’Ÿå†…æœ‰commitï¼Œåˆ™è·³è¿‡
          if [ $TIME_DIFF -lt 1800 ]; then
            echo "Last commit was ${TIME_DIFF} seconds ago, skipping..."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Proceeding with update..."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Get quote from hitokoto API
        if: steps.check-time.outputs.skip == 'false'
        id: hitokoto
        run: |
          # ä»ä¸€è¨€APIè·å–å¥å­
          RESPONSE=$(curl -s "https://v1.hitokoto.cn/?c=a&c=b&c=c&c=d&c=e&c=f&c=g&c=h&c=i&c=j&c=k&c=l")
          
          # æå–å¥å­å’Œä½œè€…
          QUOTE=$(echo $RESPONSE | jq -r '.hitokoto // "æ›´æ–°å›¾ç‰‡æ—¶é—´æˆ³"')
          AUTHOR=$(echo $RESPONSE | jq -r '.from // "ä¸€è¨€"')
          
          # å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
          if [ "$QUOTE" = "null" ] || [ -z "$QUOTE" ]; then
            QUOTE="æ›´æ–°å›¾ç‰‡æ—¶é—´æˆ³"
            AUTHOR="AUTO"
          fi
          
          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
          echo "QUOTE=$QUOTE" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "Commit message: $QUOTE â€”â€” $AUTHOR"

      - name: Update README with timestamp
        if: steps.check-time.outputs.skip == 'false'
        run: |
          # ç”Ÿæˆæ—¶é—´æˆ³
          TIMESTAMP=$(date +%s)
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          cp README.md README.md.tmp
          
          # ä½¿ç”¨sedæ›´æ–°å›¾ç‰‡é“¾æ¥ï¼Œæ·»åŠ æ—¶é—´æˆ³
          sed -i "s|\(!\[Starå†å²\](https://raw\.githubusercontent\.com/ColorFulCraft/CFCHistory/main/pictures/star-history\.svg\)[^)]*|\1?v=$TIMESTAMP|g" README.md.tmp
          sed -i "s|\(!\[ä»£ç æ´»åŠ¨\](https://raw\.githubusercontent\.com/ColorFulCraft/CFCHistory/main/pictures/repobeats\.svg\)[^)]*|\1?v=$TIMESTAMP|g" README.md.tmp
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if ! cmp -s README.md README.md.tmp; then
            mv README.md.tmp README.md
            echo "README images updated with new timestamp: $TIMESTAMP"
          else
            echo "No changes needed"
            rm README.md.tmp
            echo "NO_CHANGE=true" >> $GITHUB_ENV
          fi

      - name: Commit and push changes
        if: steps.check-time.outputs.skip == 'false' && env.NO_CHANGE != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          
          # ä½¿ç”¨ä»APIè·å–çš„å¥å­ä½œä¸ºcommitæ¶ˆæ¯
          COMMIT_MSG="ğŸ”„ $QUOTE â€”â€” $AUTHOR [skip ci]"
          echo "Committing with message: $COMMIT_MSG"
          
          git commit -m "$COMMIT_MSG"
          git push
