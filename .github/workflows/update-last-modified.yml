name: Update Last Modified Date

on:
  push:
    branches: [ "main" ]  

jobs:
  update-date:
    runs-on: ubuntu-latest
    permissions:
      contents: write  
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ fetch-depth: 0 è·å–å®Œæ•´å†å²è®°å½•
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Update last modified date
        id: update-date
        run: |
          # ä½¿ç”¨è·å–åˆ°çš„æ—¥æœŸ
          CURRENT_DATE="${{ steps.date.outputs.date }}"
          
          echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"
          
          # æŸ¥æ‰¾å¹¶æ›¿æ¢æœ€åæ›´æ–°æ—¶é—´çš„è¡Œ
          # æ³¨æ„ï¼šè¿™ä¸ªæ¨¡å¼éœ€è¦æ ¹æ®ä½ çš„ README.md å®é™…å†…å®¹è°ƒæ•´
          if grep -q "> æœ€åæ›´æ–°æ—¶é—´ï¼š" README.md; then
            sed -i "s/> æœ€åæ›´æ–°æ—¶é—´ï¼š.*/> æœ€åæ›´æ–°æ—¶é—´ï¼š$CURRENT_DATE/" README.md
            echo "å·²æ›´æ–°æ—¥æœŸ"
          else
            # å¦‚æœæ‰¾ä¸åˆ°æ¨¡å¼ï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„æ¨¡å¼
            sed -i "s/æœ€åæ›´æ–°ï¼š.*/æœ€åæ›´æ–°ï¼š$CURRENT_DATE/" README.md || \
            sed -i "s/Last updated:.*/Last updated: $CURRENT_DATE/" README.md || \
            echo "æœªæ‰¾åˆ°æ—¥æœŸæ¨¡å¼ï¼Œè¯·æ£€æŸ¥ README.md æ ¼å¼"
          fi

      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --exit-code --quiet README.md; then
            echo "æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "should_commit=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            echo "should_commit=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºæ›´æ”¹å†…å®¹
            git diff README.md
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.should_commit == 'true'
        run: |
          CURRENT_DATE="${{ steps.date.outputs.date }}"
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "ğŸ“… è‡ªåŠ¨æ›´æ–°æœ€åä¿®æ”¹æ—¥æœŸ [$CURRENT_DATE]"
          git push
        env:
          # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ token
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
