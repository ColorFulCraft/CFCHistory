name: Update Last Modified Date

on:
  push:
    branches: [ "main" ]

jobs:
  update-date:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current date
        id: date
        run: |
          DATE=$(date +'%Y-%m-%d')
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "è·å–åˆ°çš„æ—¥æœŸ: $DATE"

      - name: Update last modified date
        id: update-date
        run: |
          CURRENT_DATE="${{ steps.date.outputs.date }}"
          echo "å¼€å§‹æ›´æ–°æ—¥æœŸ: $CURRENT_DATE"
          
          # å¤‡ä»½åŸå§‹æ–‡ä»¶
          cp README.md README.md.bak
          
          # æŸ¥çœ‹æ–‡ä»¶ä¸­çš„æ—¥æœŸè¡Œ
          echo "=== æŸ¥æ‰¾åŒ…å«æ—¥æœŸçš„è¡Œ ==="
          grep -n "æœ€åæ›´æ–°æ—¶é—´\|æ©¡æœ¨å‘Šç¤ºç‰Œ" README.md
          
          # ä¸“é—¨åŒ¹é…ä½ çš„æ ¼å¼ï¼ˆåŒ…å« img æ ‡ç­¾çš„æ¨¡å¼ï¼‰
          # ä½ çš„æ ¼å¼æ˜¯ï¼š<img src="...">æœ€åæ›´æ–°æ—¶é—´ï¼š2026-02-04
          if grep -q '<img src="https://raw.githubusercontent.com/ColorFulCraft/CFCHistory/main/pictures/mc-icons/%E6%A9%A1%E6%9C%A8%E5%91%8A%E7%A4%BA%E7%89%8C.png".*æœ€åæ›´æ–°æ—¶é—´ï¼š' README.md; then
            echo "æ‰¾åˆ°å›¾ç‰‡+æ—¥æœŸæ¨¡å¼"
            # ä½¿ç”¨æ›´ç²¾ç¡®çš„ sed æ¨¡å¼
            sed -i 's/\(<img src="https:\/\/raw\.githubusercontent\.com\/ColorFulCraft\/CFCHistory\/main\/pictures\/mc-icons\/%E6%A9%A1%E6%9C%A8%E5%91%8A%E7%A4%BA%E7%89%8C\.png"[^>]*>æœ€åæ›´æ–°æ—¶é—´ï¼š\)[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/\1'"$CURRENT_DATE"'/' README.md
            echo "ä½¿ç”¨ç²¾ç¡®æ¨¡å¼æ›´æ–°æˆåŠŸ"
          elif grep -q "æœ€åæ›´æ–°æ—¶é—´ï¼š" README.md; then
            echo "æ‰¾åˆ°ç®€å•æ—¥æœŸæ¨¡å¼"
            sed -i "s/æœ€åæ›´æ–°æ—¶é—´ï¼š[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}/æœ€åæ›´æ–°æ—¶é—´ï¼š$CURRENT_DATE/" README.md
            echo "ä½¿ç”¨ç®€å•æ¨¡å¼æ›´æ–°æˆåŠŸ"
          else
            echo "æœªæ‰¾åˆ°æ—¥æœŸæ¨¡å¼ï¼Œæ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
            head -50 README.md
            exit 1
          fi
          
          # æ£€æŸ¥æ›´æ–°ç»“æœ
          echo "=== æ›´æ–°åçš„æ—¥æœŸè¡Œ ==="
          grep "æœ€åæ›´æ–°æ—¶é—´" README.md

      - name: Check for changes
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --exit-code --quiet README.md; then
            echo "æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
            echo "should_commit=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤"
            echo "should_commit=true" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºæ›´æ”¹å†…å®¹
            echo "=== å…·ä½“æ›´æ”¹å†…å®¹ ==="
            git diff README.md
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.should_commit == 'true'
        run: |
          CURRENT_DATE="${{ steps.date.outputs.date }}"
          
          git config --global user.name "CFCAT"
          git config --global user.email "leng@ipacel.cc"
          git add README.md
          git commit -m "CFCAT: ğŸ“… è‡ªåŠ¨æ›´æ–°æœ€åä¿®æ”¹æ—¥æœŸ [$CURRENT_DATE]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
