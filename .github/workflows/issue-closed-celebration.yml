name: Issue Closed Celebration

on:
  issues:
    types: [closed]

jobs:
  issue-closed-handler:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Process closed issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–issueä¿¡æ¯
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          CREATED_AT="${{ github.event.issue.created_at }}"
          CLOSED_AT="${{ github.event.issue.closed_at }}"
          
          echo "Issue #$ISSUE_NUMBER closed by $ISSUE_AUTHOR"
          echo "Created at: $CREATED_AT"
          echo "Closed at: $CLOSED_AT"

          # è·å–åˆ†é…çš„ç®¡ç†äººå‘˜
          ASSIGNEES_JSON=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}")
          
          ASSIGNEE_LIST=$(echo "$ASSIGNEES_JSON" | jq -r '.assignees[].login' | tr '\n' ' ' | sed 's/ $//')
          echo "Assignees: $ASSIGNEE_LIST"

          # è·å–ä»issueåˆ›å»ºåˆ°å…³é—­æœŸé—´çš„æ‰€æœ‰æäº¤
          TOP_USER=""
          TOP_COUNT=0
          HAS_COMMITS=false
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æäº¤
          if git log --since="$CREATED_AT" --until="$CLOSED_AT" --oneline > /dev/null 2>&1; then
            COMMITS=$(git log --since="$CREATED_AT" --until="$CLOSED_AT" --pretty=format:"%an" | sort | uniq -c | sort -nr)
            if [ -n "$COMMITS" ]; then
              HAS_COMMITS=true
              TOP_CONTRIBUTOR=$(echo "$COMMITS" | head -n 1)
              TOP_USER=$(echo "$TOP_CONTRIBUTOR" | awk '{print $2}')
              TOP_COUNT=$(echo "$TOP_CONTRIBUTOR" | awk '{print $1}')
              echo "Top contributor: $TOP_USER with $TOP_COUNT commits"
            fi
          fi

          # è·å–issueçš„æ‰€æœ‰è¯„è®ºå¹¶ç»Ÿè®¡æœ‰æƒé™ç”¨æˆ·çš„è¯„è®ºæ¬¡æ•°
          echo "Fetching issue comments..."
          COMMENTS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments?per_page=100")
          
          # ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è¯„è®ºæ¬¡æ•°ï¼ˆæ’é™¤issueä½œè€…ï¼‰
          declare -A COMMENT_COUNTS
          HAS_COMMUNITY_CONTRIBUTORS=false
          TOP_COMMENTER=""
          TOP_COMMENT_COUNT=0
          
          # æå–è¯„è®ºç”¨æˆ·
          COMMENTERS=$(echo "$COMMENTS_RESPONSE" | jq -r '.[] | select(.user.login != "'$ISSUE_AUTHOR'") | .user.login')
          
          if [ -n "$COMMENTERS" ]; then
            while read -r commenter; do
              if [ -n "$commenter" ]; then
                # æ£€æŸ¥ç”¨æˆ·æƒé™
                PERMISSION_CHECK=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/${{ github.repository }}/collaborators/${commenter}/permission" 2>/dev/null || echo '{"permission":"none"}')
                
                PERMISSION_LEVEL=$(echo "$PERMISSION_CHECK" | jq -r '.permission')
                
                # åªç»Ÿè®¡æœ‰æƒé™çš„ç”¨æˆ·ï¼ˆadmin, write, maintainï¼‰
                if [ "$PERMISSION_LEVEL" = "admin" ] || [ "$PERMISSION_LEVEL" = "write" ] || [ "$PERMISSION_LEVEL" = "maintain" ]; then
                  ((COMMENT_COUNTS[$commenter]++))
                  HAS_COMMUNITY_CONTRIBUTORS=true
                  echo "Found comment from staff: $commenter (permission: $PERMISSION_LEVEL)"
                  
                  # æ›´æ–°æœ€å¤šè¯„è®ºè€…
                  if [ "${COMMENT_COUNTS[$commenter]}" -gt "$TOP_COMMENT_COUNT" ]; then
                    TOP_COMMENT_COUNT="${COMMENT_COUNTS[$commenter]}"
                    TOP_COMMENTER="$commenter"
                  fi
                fi
              fi
            done <<< "$COMMENTERS"
          fi

          # æ„å»ºæ¶ˆæ¯
          MESSAGE="@$ISSUE_AUTHOR ä½ çš„é—®é¢˜è§£å†³å•¦ï¼Œå˜»å˜» ğŸ‰\n\n"
          
          # å¦‚æœæœ‰åˆ†é…çš„ç®¡ç†äººå‘˜ï¼Œæ„Ÿè°¢ä»–ä»¬
          if [ -n "$ASSIGNEE_LIST" ]; then
            MESSAGE+="@$ASSIGNEE_LIST æ„Ÿè°¢ä½ ä»¬çš„ä»˜å‡ºï¼ğŸ‘\n\n"
          else
            MESSAGE+="æ„Ÿè°¢æ‰€æœ‰å‚ä¸è§£å†³é—®é¢˜çš„è´¡çŒ®è€…ï¼ğŸ‘\n\n"
          fi
          
          # ä»£ç è´¡çŒ®ç»Ÿè®¡
          MESSAGE+="**ä»£ç è´¡çŒ®ç»Ÿè®¡ï¼š**\n"
          if [ "$HAS_COMMITS" = true ] && [ -n "$TOP_USER" ] && [ "$TOP_COUNT" -gt 0 ]; then
            MESSAGE+="ğŸ† æœ€é«˜è´¡çŒ®ï¼š@$TOP_USER ï¼ˆ$TOP_COUNT æ¬¡æäº¤ï¼‰\n"
          else
            MESSAGE+="ğŸ“Š æš‚æ— ä»£ç æäº¤æ•°æ®\n"
          fi
          
          # ç¤¾åŒºè¯„è®ºè´¡çŒ®ç»Ÿè®¡
          MESSAGE+="\n**ç¤¾åŒºäº’åŠ¨ç»Ÿè®¡ï¼š**\n"
          if [ "$HAS_COMMUNITY_CONTRIBUTORS" = true ] && [ -n "$TOP_COMMENTER" ] && [ "$TOP_COMMENT_COUNT" -gt 0 ]; then
            MESSAGE+="ğŸ’¬ æœ€æ´»è·ƒå›å¤ï¼š@$TOP_COMMENTER ï¼ˆ$TOP_COMMENT_COUNT æ¬¡å›å¤ï¼‰\n"
          else
            MESSAGE+="ğŸ’¬ æš‚æ— ç¤¾åŒºå›å¤æ•°æ®\n"
          fi

          MESSAGE+="\næ„Ÿè°¢å¤§å®¶çš„å…±åŒåŠªåŠ›ï¼â¤ï¸"

          # æ·»åŠ è¯„è®ºåˆ°å·²å…³é—­çš„issue
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -X POST \
               -d "{\"body\":\"$(echo -e "$MESSAGE")\"}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments"

          echo "Comment added to issue #$ISSUE_NUMBER"
          echo "Final message:"
          echo -e "$MESSAGE"
