name: Issue Closed Celebration

on:
  issues:
    types: [closed]

jobs:
  issue-closed-handler:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process closed issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取issue信息
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          CREATED_AT="${{ github.event.issue.created_at }}"
          CLOSED_AT="${{ github.event.issue.closed_at }}"
          
          # 获取分配的管理人员
          ASSIGNEES="${{ github.event.issue.assignees.*.login }}"
          ASSIGNEE_LIST=$(echo "$ASSIGNEES" | tr ' ' '\n' | grep -v "^$" | tr '\n' ' ')
          
          echo "Issue #$ISSUE_NUMBER closed by $ISSUE_AUTHOR"
          echo "Assignees: $ASSIGNEE_LIST"
          echo "Created at: $CREATED_AT"
          echo "Closed at: $CLOSED_AT"

          # 获取从issue创建到关闭期间的所有提交
          COMMITS=$(git log --since="$CREATED_AT" --until="$CLOSED_AT" --pretty=format:"%an" | sort | uniq -c | sort -nr)
          
          # 提取贡献最多的用户
          TOP_CONTRIBUTOR=$(echo "$COMMITS" | head -n 1 | awk '{print $2 ":" $1}')
          TOP_USER=$(echo "$TOP_CONTRIBUTOR" | cut -d: -f1)
          TOP_COUNT=$(echo "$TOP_CONTRIBUTOR" | cut -d: -f2)
          
          echo "Top contributor: $TOP_USER with $TOP_COUNT commits"

          # 获取issue的所有评论并统计有权限用户的评论次数
          echo "Fetching issue comments..."
          COMMENTS_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments?per_page=100")
          
          # 统计每个用户的评论次数（排除issue作者）
          declare -A COMMENT_COUNTS
          HAS_COMMUNITY_CONTRIBUTORS=false
          
          # 提取评论数据
          COMMENT_DATA=$(echo "$COMMENTS_RESPONSE" | jq -r '.[] | select(.user.login != "'$ISSUE_AUTHOR'") | .user.login')
          
          # 统计评论次数
          while read -r commenter; do
            if [ -n "$commenter" ]; then
              # 检查用户权限
              PERMISSION_CHECK=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/collaborators/${commenter}/permission")
              
              PERMISSION_LEVEL=$(echo "$PERMISSION_CHECK" | jq -r '.permission')
              
              # 只统计有权限的用户（admin, write, maintain）
              if [ "$PERMISSION_LEVEL" = "admin" ] || [ "$PERMISSION_LEVEL" = "write" ] || [ "$PERMISSION_LEVEL" = "maintain" ]; then
                ((COMMENT_COUNTS[$commenter]++))
                HAS_COMMUNITY_CONTRIBUTORS=true
                echo "Found comment from staff: $commenter (permission: $PERMISSION_LEVEL)"
              fi
            fi
          done <<< "$COMMENT_DATA"
          
          # 找出评论最多的社区贡献者
          TOP_COMMENTER=""
          TOP_COMMENT_COUNT=0
          for commenter in "${!COMMENT_COUNTS[@]}"; do
            if [ "${COMMENT_COUNTS[$commenter]}" -gt "$TOP_COMMENT_COUNT" ]; then
              TOP_COMMENT_COUNT="${COMMENT_COUNTS[$commenter]}"
              TOP_COMMENTER="$commenter"
            fi
          done

          # 构建消息
          MESSAGE="@$ISSUE_AUTHOR 你的问题解决啦，嘻嘻 🎉\n\n"
          
          # 如果有分配的管理人员，感谢他们
          if [ -n "$ASSIGNEE_LIST" ]; then
            MESSAGE+="$(echo "$ASSIGNEE_LIST" | sed 's/ / /g' | sed 's/^/@/g' | sed 's/ / @/g') 感谢你们的付出！👏\n\n"
          fi
          
          # 如果有代码贡献最多的用户，特别感谢
          if [ -n "$TOP_USER" ] && [ "$TOP_COUNT" -gt 0 ]; then
            MESSAGE+="特别感谢：@$TOP_USER ：累计贡献 $TOP_COUNT 次！🚀\n\n"
          else
            MESSAGE+="感谢所有参与解决问题的贡献者！💪\n\n"
          fi
          
          # 如果有社区评论贡献者，添加感谢
          if [ "$HAS_COMMUNITY_CONTRIBUTORS" = true ] && [ -n "$TOP_COMMENTER" ] && [ "$TOP_COMMENT_COUNT" -gt 0 ]; then
            MESSAGE+="感谢社区贡献：@$TOP_COMMENTER （累计回复 $TOP_COMMENT_COUNT 次）🙌"
          fi

          # 添加评论到已关闭的issue
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               -X POST \
               -d "{\"body\":\"$MESSAGE\"}" \
               "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments"

          echo "Comment added to issue #$ISSUE_NUMBER"
          echo "Final message:"
          echo "$MESSAGE"
